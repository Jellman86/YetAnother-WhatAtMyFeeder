Role: You are a senior software engineer and refactoring specialist. Your task is to refactor the WhosAtMyFeeder codebase to modern, widely adopted tooling and patterns without breaking current functionality. Perform an incremental, cautious refactor that maximizes safety, observability, and test coverage. Then, redesign the Web UI to align with BirdNET‑Go’s user interface and interaction model.
Important context (facts you must respect):

WhosAtMyFeeder is a Frigate sidecar that consumes MQTT events and classifies bird species using Google’s TFHub birds model; it has a Python-based web UI layer and uses a docker-compose.yml. [github.com]
BirdNET‑Go provides a modern web dashboard for real‑time detection and configuration; the repo evidences a contemporary frontend (Svelte 5 + Tailwind, i18n, SSE), plus documented Docker Compose deployment and feature set that should guide the UI parity you deliver. [github.com], [github.com], [github.com]


Objectives


Cautious Refactor (Backend + Infrastructure)

Preserve all current features: Frigate integration, MQTT consumption, snapshot/video references, species classification via TFHub model, and current data storage semantics. [github.com]
Upgrade runtime and dependencies to widely used modern versions (e.g., Python 3.12, latest stable TensorFlow Lite/compatible libs, MQTT client, web framework).
Introduce structured logging, robust configuration management, type hints, linting, formatting, unit/integration tests, and CI/CD.
Maintain existing external contracts (MQTT topics, HTTP endpoints, DB/file formats) or provide compatibility shims plus migration scripts.
Containerize with Docker Compose v2 (Compose spec), healthchecks, and .env support; keep images minimal and reproducible. Provide sample Compose files and a hardening checklist. (BirdNET‑Go’s Docker docs are your reference when defining best‑practice compose patterns.) [github.com]
Add observability: metrics endpoints (Prometheus style), request/processing timings, error rates, and a support dump.



Web UI Redesign (Parity with BirdNET‑Go)

Create a modern UI that closely mirrors BirdNET‑Go in information architecture and UX conventions:

Dashboard with real‑time detections, confidence, species, timestamps, quick filters; live updates via SSE.
Events/Detections explorer with search, species filters, date range, and detail drawer (image, clip link).
Species Leaderboard and Trends (top species, detections over time).
Settings pages for thresholds, MQTT broker, Frigate endpoint, notifications, privacy filters, and authentication.
About/Status: version, health, telemetry toggle, storage usage.


Implement the frontend using Svelte 5 + Tailwind CSS with i18n support and accessible components; follow the repo’s evidence of a Svelte-based modern UI in BirdNET‑Go for consistency. [github.com]
Provide dark/light themes, keyboard navigation, responsive layout, and offline-friendly behavior for cached media.
Ensure no breaking changes to backend APIs; where needed, introduce a thin API layer that the UI consumes.




Constraints & Non‑Goals

Do not rewrite from scratch. Use the Strangler Fig approach: carve out modules, wrap old interfaces, and replace piece‑by‑piece behind tests.
Minimize risk: retain the existing classifier model integration and Frigate snapshot/video references. [github.com]
Prefer well‑adopted tools over niche ones:

Python: FastAPI (or Flask if easiest), pydantic/pydantic-settings, uvicorn, pytest, mypy, ruff, black, structlog.
Frontend: Svelte 5, Tailwind, Vite, vitest + Playwright for tests.
CI: GitHub Actions with matrix builds; add Renovate for dependency updates.


Security: implement OAuth2 or token auth for the UI/API, rate limiting, input validation, CORS rules, and production reverse proxy headers (NPM/Traefik compatible).


Deliverables


Architecture & Refactor Plan (Markdown)

Before coding, generate a plan with:

Current-state inventory (modules, dependencies, endpoints, MQTT topics, DB/files).
Target-state architecture diagram and module boundaries.
Refactor steps in small PR-sized batches with roll‑back strategy.





Backend Modernization

Upgrade to Python 3.12; enforce type hints; replace ad‑hoc config with pydantic-settings.
New api/ module with FastAPI endpoints that wrap existing logic; expose /health, /metrics, /events, /species, /settings.
Structured logging (structlog) with correlation IDs; error taxonomy.
Tests: unit (classifier, MQTT handler), integration (Frigate snapshot retrieval), end‑to‑end (Docker Compose with Mosquitto + mock Frigate).
GitHub Actions workflow: lint, type‑check, test, build image, push to registry on tag.



Web UI (Svelte 5)

apps/ui/ project with Svelte + Tailwind; routes: /, /events, /species, /settings, /about.
Live updates via SSE (server endpoint /stream/events); optimistic UI where safe.
Components: DetectionCard, SpeciesChart, FiltersBar, SettingsForm, HealthBadge.
i18n scaffolding (en baseline) and accessibility checks; unit and Playwright tests.



Ops & Packaging

docker/compose.yml (v2) with services: feeder-api, feeder-ui, mqtt, db (if used), plus healthchecks and .env.
Production Dockerfiles (multi‑stage), SBOM generation, image signing.
SECURITY.md, PRIVACY.md, CONTRIBUTING.md, SUPPORT.md.
Migration guide: schema changes, config keys, environment vars; backward compatibility notes.



UI Parity Notes

A short comparison doc explaining how the new UI aligns with BirdNET‑Go concepts (dashboard layout, settings categories, real-time stream). [github.com], [github.com]




Step‑by‑Step Plan for You (Gemini)

Repository Intake: Parse the repo (code, docker-compose.yml, web UI templates, requirements) and produce a Current-State Report. Confirm the TFHub model usage and MQTT/Frigate assumptions. [github.com]
Design Target Architecture: Propose module boundaries, data flow, and API surface that preserves existing behavior while enabling the new UI and observability.
Create Refactor Roadmap: Sequence changes into safe increments (config system → typing → logging → tests → API façade → UI).
Implement & Verify Each Increment: After each step, run tests and a local Docker Compose environment; capture metrics and health status. Use feature flags if removing old paths.
Build New Svelte UI: Implement pages and components, connect to API/SSE, and validate UX parity with BirdNET‑Go’s dashboard conventions. [github.com]
Ship & Document: Produce release notes, migration guide, and a cut-over checklist.


Acceptance Criteria

Functional parity with existing WhosAtMyFeeder behavior (Frigate+MQTT+species classification; images from Frigate; video clips shown; sub-label handling remains consistent). [github.com]
Test coverage ≥70% for core logic; CI is green; images build reproducibly.
UI shows real-time detections, filters, species leaderboard, and configurable settings matching BirdNET‑Go’s feature groups; accessible and responsive. [github.com], [github.com]
Observability: /metrics endpoint, /health checks, structured logs, support dump.
Security: Auth in UI, protected API routes, sensible defaults, and no sensitive ports exposed by default.


Notes on Alignment with BirdNET‑Go

Use SSE for real-time detection stream and a dashboard-first UX similar to BirdNET‑Go’s web interface and wiki-described features (real-time analysis, configurable thresholds, notifications). [github.com]
Prefer Svelte 5 + Tailwind to mirror BirdNET‑Go’s modern frontend stack evidenced in the repo tree (Svelte 5 UI folder and frontend updates). [github.com]
Follow Docker Compose best practices demonstrated in BirdNET‑Go’s docs when defining your deployment. [github.com]